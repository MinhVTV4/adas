<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver Monitor v19 (Smart Timing)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MediaPipe Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        body { background-color: #020617; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .camera-wrapper { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        video, canvas { position: absolute; max-width: 100%; max-height: 100%; transform: scaleX(-1); object-fit: cover; }

        /* --- GLASS UI --- */
        .glass-panel {
            background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-radius: 16px;
        }

        /* --- MONITOR BAR --- */
        .monitor-bar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 600px; z-index: 40; padding: 15px;
            display: flex; gap: 20px; transition: opacity 0.5s; align-items: stretch;
        }
        .section-eyes { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .bar-track {
            height: 20px; width: 100%; border-radius: 10px; margin: 5px 0;
            background: linear-gradient(to right, #ef4444 0%, #ef4444 30%, #eab308 45%, #eab308 55%, #22c55e 70%, #22c55e 100%);
            position: relative; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        .bar-cursor {
            position: absolute; top: 0; bottom: 0; width: 6px; background: #fff;
            box-shadow: 0 0 10px #fff; transition: left 0.1s linear; z-index: 10; border: 1px solid #000;
        }
        .thresh-line {
            position: absolute; top: 0; bottom: 0; width: 2px; background: rgba(255,255,255,0.8); 
            border-left: 1px dashed black; z-index: 5;
        }
        .fatigue-wrapper { display: flex; align-items: center; gap: 8px; margin-top: 2px; }
        .fatigue-label { font-size: 10px; color: #94a3b8; font-weight: bold; }
        .fatigue-indicator { flex: 1; height: 6px; background: #334155; border-radius: 3px; display: flex; overflow: hidden; }
        .fatigue-dot { flex: 1; margin-right: 1px; background: #475569; transition: background 0.3s; }
        .fatigue-dot.active { background: #eab308; box-shadow: 0 0 5px #eab308; }

        /* RIGHT: HEAD COMPASS */
        .section-head { 
            width: 80px; border-left: 1px solid rgba(255,255,255,0.15); padding-left: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .head-compass {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.3); position: relative; margin-top: 5px; transition: border-color 0.2s;
        }
        .head-compass.warning { border-color: #f97316; background: rgba(249, 115, 22, 0.2); }
        
        .head-safe-zone {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; border-radius: 50%;
            border: 1px dashed rgba(34, 197, 94, 0.6); background: rgba(34, 197, 94, 0.1);
        }
        .head-dot {
            width: 10px; height: 10px; background: #3b82f6; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 5px #3b82f6; transition: all 0.1s;
        }

        /* --- ALERTS --- */
        .alarm-screen {
            position: absolute; inset: 0; background: rgba(220, 38, 38, 0.95); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .alarm-active { opacity: 1; pointer-events: auto; animation: pulseAlarm 0.5s infinite; }
        @keyframes pulseAlarm { 50% { background: rgba(220, 38, 38, 0.7); } }

        .warning-overlay {
            position: absolute; top: 130px; left: 50%; transform: translateX(-50%);
            padding: 12px 25px; border-radius: 50px;
            z-index: 90; display: flex; align-items: center; gap: 15px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
            box-shadow: 0 0 30px rgba(0,0,0, 0.6);
        }
        .warn-yellow { background: rgba(234, 179, 8, 0.95); }
        .warn-orange { background: rgba(249, 115, 22, 0.95); }
        .warning-active { opacity: 1; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }

        /* --- SETTINGS MENU --- */
        .settings-menu {
            position: absolute; bottom: 90px; right: 20px; width: 280px;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
            border: 1px solid #334155; border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 80; transform: translateY(20px); opacity: 0; pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .settings-menu.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .menu-item { background: rgba(255,255,255,0.05); border: none; color: white; padding: 12px; border-radius: 8px; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .menu-item.danger { color: #f87171; background: rgba(239, 68, 68, 0.1); } 
        .setting-group { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; }
        input[type=range] { width: 100%; height: 4px; background: #475569; border-radius: 2px; appearance: none; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #3b82f6; cursor: pointer; }

        /* --- CONTROLS --- */
        .btn-round { width: 50px; height: 50px; border-radius: 25px; background: rgba(30, 41, 59, 0.9); border: 1px solid #475569; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .btn-action { width: 100%; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-green { background: #22c55e; color: white; }

        /* --- TRAINING --- */
        .top-instruction-box {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 450px; z-index: 50; padding: 20px;
            text-align: center; display: flex; flex-direction: column; gap: 10px;
        }
        .countdown-overlay { position: absolute; inset: 0; z-index: 60; background: rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .count-num { font-size: 8rem; font-weight: 900; color: #fff; text-shadow: 0 0 30px rgba(0,0,0,0.8); animation: popIn 0.8s; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #00ffff; box-shadow: 0 0 10px #00ffff; opacity: 0.6; animation: scanUpDown 2s infinite linear; pointer-events: none; }
        @keyframes scanUpDown { 0% { top: 10%; } 100% { top: 90%; } }
        .progress-track { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 0.1s linear; }
    </style>
</head>
<body>

    <div class="camera-wrapper">
        <video class="input_video" style="display: none;"></video>
        <canvas class="output_canvas"></canvas>
        <div id="scanner" class="absolute inset-0 hidden pointer-events-none"><div class="scan-line"></div></div>
        <div id="countdownBox" class="countdown-overlay hidden"><div id="countNum" class="count-num">3</div></div>

        <!-- ALARMS -->
        <div id="alarmScreen" class="alarm-screen">
            <div class="text-9xl mb-4 animate-bounce">üö®</div>
            <h1 class="text-6xl font-black uppercase text-white drop-shadow-xl mb-6">T·ªàNH D·∫¨Y!</h1>
            <button id="btnWakeUp" class="bg-white text-red-600 px-10 py-4 rounded-full font-bold text-2xl shadow-xl hover:scale-105 transition">T√îI ƒê√É T·ªàNH</button>
        </div>

        <div id="warningOverlay" class="warning-overlay warn-yellow">
            <div class="text-4xl" id="warnIcon">‚òï</div>
            <div class="text-left">
                <div class="text-black font-black text-xl leading-none" id="warnTitle">C·∫¢NH B√ÅO</div>
                <div class="text-black font-semibold text-sm" id="warnSub">...</div>
            </div>
        </div>

        <!-- MONITOR BAR -->
        <div id="monitorBar" class="glass-panel monitor-bar opacity-0 pointer-events-none">
            <div class="section-eyes">
                <div class="flex justify-between text-xs font-bold text-gray-200 px-1"><span>‚ö†Ô∏è NH·∫ÆM</span><span>‚úÖ M·ªû</span></div>
                <div class="bar-track">
                    <div id="threshLine" class="thresh-line" style="left: 40%"></div>
                    <div id="barCursor" class="bar-cursor" style="left: 90%"></div>
                </div>
                <div class="fatigue-wrapper">
                    <span class="fatigue-label">M·ªÜT M·ªéI:</span>
                    <div class="fatigue-indicator"><div id="dot1" class="fatigue-dot"></div><div id="dot2" class="fatigue-dot"></div><div id="dot3" class="fatigue-dot"></div></div>
                </div>
                <div id="monitorStatus" class="text-center mt-2 text-sm font-bold text-green-400">ƒêang ho·∫°t ƒë·ªông</div>
            </div>
            <div class="section-head">
                <div class="text-[9px] text-gray-400 font-bold mb-1">LA B√ÄN</div>
                <div id="headCompass" class="head-compass">
                    <div class="head-safe-zone"></div>
                    <div id="headDot" class="head-dot"></div>
                </div>
            </div>
        </div>

        <!-- TRAINING UI -->
        <div id="trainingContainer">
            <div id="stepWelcome" class="glass-panel top-instruction-box">
                <h1 class="text-xl font-bold text-blue-400">Driver Monitor v19</h1>
                <p class="text-gray-300 text-xs">Smart Timing & Real-World Calibration</p>
                <div id="foundDataBox" class="hidden bg-green-500/20 border border-green-500/50 p-2 rounded text-green-300 text-xs text-left">‚ú® ƒê√£ c√≥ d·ªØ li·ªáu c≈©.</div>
                <div class="flex gap-2 w-full mt-2">
                    <button id="btnUseOld" class="btn-action btn-green hidden text-sm">D√πng d·ªØ li·ªáu c≈©</button>
                    <button id="btnNewTrain" class="btn-action btn-blue text-sm">Hu·∫•n luy·ªán m·ªõi</button>
                </div>
            </div>
            
            <div id="stepInstructOpen" class="glass-panel top-instruction-box hidden">
                <div class="flex items-center justify-center gap-2"><span class="text-2xl">üöó</span><h2 class="text-lg font-bold">B∆∞·ªõc 1: T∆∞ Th·∫ø L√°i</h2></div>
                <div class="text-left text-xs text-gray-300 bg-black/20 p-3 rounded">
                    <p class="text-yellow-400 font-bold mb-1">QUAN TR·ªåNG:</p>
                    <p>‚Ä¢ Ng·ªìi t∆∞ th·∫ø l√°i xe, <b class="text-white">m·∫Øt nh√¨n th·∫≥ng ra ƒë∆∞·ªùng</b>.</p>
                    <p>‚Ä¢ KH√îNG nh√¨n ƒëi·ªán tho·∫°i trong 2s ƒë·∫ßu.</p>
                </div>
                <button id="btnStartOpen" class="btn-action btn-blue">B·∫Øt ƒë·∫ßu ƒêo (5s)</button>
            </div>
            
            <div id="stepInstructClosed" class="glass-panel top-instruction-box hidden">
                <div class="flex items-center justify-center gap-2"><span class="text-2xl">üòå</span><h2 class="text-lg font-bold">B∆∞·ªõc 2: M·∫Øt Nh·∫Øm</h2></div>
                <div class="text-left text-xs text-gray-300 bg-black/20 p-3 rounded"><p>‚Ä¢ Nh·∫Øm m·∫Øt l·∫°i.</p><p>‚Ä¢ Quay ƒë·∫ßu t·ª± do.</p></div>
                <button id="btnStartClosed" class="btn-action btn-blue">B·∫Øt ƒë·∫ßu</button>
            </div>
            
            <div id="stepProcessing" class="glass-panel top-instruction-box hidden">
                <h2 class="text-lg font-bold text-blue-400" id="processTitle">ƒêang h·ªçc...</h2>
                <div class="text-xs text-yellow-400 font-bold mt-1 hidden" id="calibMsg">NH√åN TH·∫≤NG ƒê∆Ø·ªúNG!</div>
                <div class="progress-track"><div id="progressBar" class="progress-fill" style="width: 0%"></div></div>
            </div>
            
            <div id="stepSuccess" class="glass-panel top-instruction-box hidden">
                <h2 class="text-lg font-bold">Ho√†n t·∫•t!</h2>
                <div class="text-xs text-gray-400">H·ªá th·ªëng ƒë√£ ghi nh·ªõ t∆∞ th·∫ø c·ªßa b·∫°n.</div>
                <button id="btnFinish" class="btn-action btn-blue mt-2">B·∫Øt ƒë·∫ßu Gi√°m S√°t</button>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="settingsMenu" class="settings-menu">
            <div class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">C√†i ƒë·∫∑t</div>
            <button id="menuMute" class="menu-item"><span>üîä</span> <span id="txtMute">√Çm thanh: B·∫¨T</span></button>
            <div class="setting-group">
                <div class="setting-label"><span>ƒê·ªô tr·ªÖ b√°o ƒë·ªông</span><span id="delayVal" class="setting-value">1.0s</span></div>
                <input type="range" id="delaySlider" min="20" max="60" step="5" value="30">
            </div>
            <button id="menuRetrain" class="menu-item"><span>üîÑ</span> Train l·∫°i t·ª´ ƒë·∫ßu</button>
            <button id="menuReset" class="menu-item danger"><span>üóëÔ∏è</span> X√≥a d·ªØ li·ªáu c≈©</button>
        </div>

        <div id="bottomControls" class="absolute bottom-5 right-5 flex gap-2 hidden z-40">
            <button id="btnQuickMute" class="btn-round">üîä</button>
            <button id="btnOpenSettings" class="btn-round">‚öôÔ∏è</button>
        </div>
    </div>

    <script>
        const APP = {
            mode: 'IDLE', 
            config: {
                avgOpen: 0.35, avgClosed: 0.15, eyeThreshold: 0.25,
                calibratedPitch: 0, calibratedYaw: 0,
                framesToAlarm: 30, 
                // Increased distraction tolerance to ~3 seconds
                distractionFrames: 90 
            },
            runtime: {
                currentEAR: 0, currentPitch: 0, currentYaw: 0,
                closedCounter: 0, distractionCounter: 0,
                isAlarming: false, isMuted: false, warningType: null,
                recentSlowBlinks: []
            },
            tempTrainData: [], calibData: { pitch: 0, yaw: 0, count: 0 }
        };

        const INDICES = { 
            LEFT: [33, 160, 158, 133, 153, 144], RIGHT: [362, 385, 387, 263, 373, 380],
            NOSE: 1, CHIN: 152, FOREHEAD: 10, LEFT_CHEEK: 234, RIGHT_CHEEK: 454
        };
        
        const UI = {
            video: document.querySelector('.input_video'), canvas: document.querySelector('.output_canvas'),
            ctx: document.querySelector('.output_canvas').getContext('2d'),
            scanner: document.getElementById('scanner'), countdownBox: document.getElementById('countdownBox'), countNum: document.getElementById('countNum'),
            trainingContainer: document.getElementById('trainingContainer'), stepWelcome: document.getElementById('stepWelcome'),
            stepInstructOpen: document.getElementById('stepInstructOpen'), stepInstructClosed: document.getElementById('stepInstructClosed'),
            stepProcessing: document.getElementById('stepProcessing'), stepSuccess: document.getElementById('stepSuccess'),
            progressBar: document.getElementById('progressBar'), processTitle: document.getElementById('processTitle'),
            calibMsg: document.getElementById('calibMsg'), foundDataBox: document.getElementById('foundDataBox'), btnUseOld: document.getElementById('btnUseOld'),
            monitorBar: document.getElementById('monitorBar'), barCursor: document.getElementById('barCursor'),
            threshLine: document.getElementById('threshLine'), monitorStatus: document.getElementById('monitorStatus'),
            headCompass: document.getElementById('headCompass'), headDot: document.getElementById('headDot'),
            dots: [document.getElementById('dot1'), document.getElementById('dot2'), document.getElementById('dot3')],
            alarmScreen: document.getElementById('alarmScreen'), warningOverlay: document.getElementById('warningOverlay'),
            warnIcon: document.getElementById('warnIcon'), warnTitle: document.getElementById('warnTitle'), warnSub: document.getElementById('warnSub'),
            bottomControls: document.getElementById('bottomControls'), settingsMenu: document.getElementById('settingsMenu'),
            btnQuickMute: document.getElementById('btnQuickMute'), txtMute: document.getElementById('txtMute'),
            delaySlider: document.getElementById('delaySlider'), delayVal: document.getElementById('delayVal')
        };

        function speak(text) { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'vi-VN'; window.speechSynthesis.speak(u); } }
        function showStep(stepId) { [UI.stepWelcome, UI.stepInstructOpen, UI.stepInstructClosed, UI.stepProcessing, UI.stepSuccess].forEach(el => el.classList.add('hidden')); document.getElementById(stepId).classList.remove('hidden'); }
        function dist(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }
        
        function getEAR(lm) {
            const getEye = (indices) => { const p = indices.map(i => lm[i]); return (dist(p[1], p[5]) + dist(p[2], p[4])) / (2.0 * dist(p[0], p[3])); };
            return (getEye(INDICES.LEFT) + getEye(INDICES.RIGHT)) / 2.0;
        }

        function getHeadPose(lm) {
            const nose = lm[INDICES.NOSE]; const chin = lm[INDICES.CHIN]; const forehead = lm[INDICES.FOREHEAD];
            const leftCheek = lm[INDICES.LEFT_CHEEK]; const rightCheek = lm[INDICES.RIGHT_CHEEK];
            const faceHeight = dist(forehead, chin); const faceWidth = dist(leftCheek, rightCheek);
            const midFaceY = (forehead.y + chin.y) / 2; const midFaceX = (leftCheek.x + rightCheek.x) / 2;
            const pitch = (nose.y - midFaceY) / faceHeight;
            const yaw = (nose.x - midFaceX) / faceWidth;
            return { pitch, yaw };
        }

        function checkStorage() {
            const data = localStorage.getItem('dm_v19_smart');
            if (data) { 
                APP.config = { ...APP.config, ...JSON.parse(data) }; 
                UI.delaySlider.value = APP.config.framesToAlarm; updateDelayVal(APP.config.framesToAlarm);
                UI.foundDataBox.classList.remove('hidden'); UI.btnUseOld.classList.remove('hidden'); 
            }
        }
        function saveConfig() { localStorage.setItem('dm_v19_smart', JSON.stringify(APP.config)); }
        function clearConfig() { localStorage.removeItem('dm_v19_smart'); location.reload(); }

        let audioCtx, osc;
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playTone(type) {
            if(APP.runtime.isMuted) return;
            if(audioCtx?.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
            if (type === 'FATIGUE') { 
                o.type = 'sine'; o.frequency.setValueAtTime(880, audioCtx.currentTime); 
                g.gain.setValueAtTime(0.5, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.0);
                o.start(); o.stop(audioCtx.currentTime + 1.0);
            } else if (type === 'DISTRACTION') {
                o.type = 'square'; o.frequency.setValueAtTime(500, audioCtx.currentTime);
                g.gain.setValueAtTime(0.3, audioCtx.currentTime); o.start();
                g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.setValueAtTime(0, audioCtx.currentTime + 0.1);
                g.gain.setValueAtTime(0.3, audioCtx.currentTime + 0.2); g.gain.setValueAtTime(0, audioCtx.currentTime + 0.3);
                o.stop(audioCtx.currentTime + 0.4);
            } else if (type === 'ALARM') {
                o.type = 'sawtooth'; o.frequency.setValueAtTime(600, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(900, audioCtx.currentTime + 0.2);
                g.gain.value = 0.8; o.start(); osc = o; 
                const loop = setInterval(() => { if(!APP.runtime.isAlarming || !osc) { clearInterval(loop); return; } const t = audioCtx.currentTime; osc.frequency.setValueAtTime(600, t); osc.frequency.linearRampToValueAtTime(900, t + 0.3); }, 500);
            }
        }
        function stopAlarm() { if(osc) { try{ osc.stop(); osc.disconnect(); }catch(e){} osc = null; } APP.runtime.isAlarming = false; }

        function startCountdown(onComplete) {
            UI.countdownBox.classList.remove('hidden'); let count = 3; UI.countNum.innerText = count; speak("3");
            const t = setInterval(() => { count--; if(count>0){UI.countNum.innerText=count;speak(count.toString());}else{clearInterval(t);UI.countdownBox.classList.add('hidden');speak("B·∫Øt ƒë·∫ßu");onComplete();} }, 1000);
        }

        function runCapture(mode) {
            APP.mode = mode; 
            APP.tempTrainData = []; 
            APP.calibData = { pitch: 0, yaw: 0, count: 0 };
            
            showStep('stepProcessing'); UI.scanner.classList.remove('hidden');
            UI.processTitle.innerText = mode === 'TRAIN_OPEN' ? "Gi·ªØ t∆∞ th·∫ø l√°i xe..." : "Nh·∫Øm m·∫Øt & Quay ƒë·∫ßu...";
            UI.progressBar.style.width = '0%';

            let captureCalib = (mode === 'TRAIN_OPEN');
            if(captureCalib) { UI.calibMsg.classList.remove('hidden'); speak("Nh√¨n th·∫≥ng ƒë∆∞·ªùng"); }

            const duration = 5000; 
            const start = Date.now();
            
            const loop = () => {
                const elapsed = Date.now() - start;
                const pct = Math.min(100, (elapsed / duration) * 100);
                UI.progressBar.style.width = `${pct}%`;
                if (captureCalib && elapsed > 2000 && elapsed < 2100) {
                     UI.calibMsg.classList.add('hidden'); UI.processTitle.innerText = "Gi·ªù h√£y quay ƒë·∫ßu...";
                }
                if (elapsed < duration) requestAnimationFrame(loop);
                else finishCapture(mode);
            };
            loop();
        }

        function finishCapture(mode) {
            UI.scanner.classList.add('hidden'); UI.calibMsg.classList.add('hidden');
            const avgEAR = APP.tempTrainData.reduce((a,b)=>a+b,0) / (APP.tempTrainData.length || 1);
            if (mode === 'TRAIN_OPEN') {
                APP.config.avgOpen = avgEAR;
                if(APP.calibData.count > 0) {
                    APP.config.calibratedPitch = APP.calibData.pitch / APP.calibData.count;
                    APP.config.calibratedYaw = APP.calibData.yaw / APP.calibData.count;
                }
                speak("Xong b∆∞·ªõc 1"); showStep('stepInstructClosed');
            } else {
                APP.config.avgClosed = avgEAR;
                APP.config.eyeThreshold = (APP.config.avgOpen + APP.config.avgClosed) / 2;
                if (Math.abs(APP.config.avgOpen - APP.config.avgClosed) < 0.01) { 
                    APP.config.avgClosed = 0.15; APP.config.avgOpen = 0.35; APP.config.eyeThreshold = 0.25;
                }
                saveConfig();
                speak("Ho√†n t·∫•t"); showStep('stepSuccess');
            }
        }

        function startMonitor() {
            APP.mode = 'MONITOR';
            UI.trainingContainer.classList.add('hidden');
            UI.monitorBar.classList.remove('opacity-0', 'pointer-events-none');
            UI.bottomControls.classList.remove('hidden');
            let range = APP.config.avgOpen - APP.config.avgClosed; if(range <= 0) range = 0.1;
            let pct = (APP.config.eyeThreshold - APP.config.avgClosed) / range;
            UI.threshLine.style.left = `${Math.max(5, Math.min(95, pct * 100))}%`;
            APP.runtime.closedCounter = 0; APP.runtime.distractionCounter = 0; APP.runtime.recentSlowBlinks = [];
        }

        function processMonitor(ear, pitch, yaw) {
            // EYES
            APP.runtime.currentEAR = (APP.runtime.currentEAR * 0.7) + (ear * 0.3);
            let range = APP.config.avgOpen - APP.config.avgClosed; if(range <= 0) range = 0.2;
            let percent = (APP.runtime.currentEAR - APP.config.avgClosed) / range;
            UI.barCursor.style.left = `${Math.max(0, Math.min(100, percent * 100))}%`;

            // HEAD
            const pDiff = pitch - APP.config.calibratedPitch;
            const yDiff = yaw - APP.config.calibratedYaw;
            
            // Logic Threshold = 0.12 (approx 12 degrees)
            const HEAD_THRESH = 0.12;
            
            // Map logic threshold to CSS displacement
            let topPos = 50 + (pDiff * 170); 
            let leftPos = 50 + (yDiff * 170);
            
            const limit = (val) => Math.max(10, Math.min(90, val));
            UI.headDot.style.top = `${limit(topPos)}%`; UI.headDot.style.left = `${limit(leftPos)}%`;

            const isDistracted = (Math.abs(pDiff) > HEAD_THRESH || Math.abs(yDiff) > HEAD_THRESH);
            
            // Immediate Visual Feedback
            if (isDistracted) {
                UI.headDot.style.backgroundColor = '#ef4444';
                UI.headCompass.classList.add('warning'); // Orange border
            } else {
                UI.headDot.style.backgroundColor = '#3b82f6';
                UI.headCompass.classList.remove('warning');
            }

            // LOGIC
            if (APP.runtime.currentEAR < APP.config.eyeThreshold) {
                // EYES CLOSED
                APP.runtime.closedCounter++;
                UI.barCursor.style.background = '#ef4444';
                // CRITICAL FIX: Do NOT reset distraction counter here.
                // Just pause it. Or let it run if head is still turned.
                // Assuming people might blink while looking away.
            } else {
                // EYES OPEN
                if (APP.runtime.closedCounter > 0) {
                    const frames = APP.runtime.closedCounter;
                    // Slow Blink: Requires at least 12 frames (~0.4s) to prevent false positives from lazy blinks
                    if (frames >= 12 && frames < APP.config.framesToAlarm) {
                        const now = Date.now();
                        APP.runtime.recentSlowBlinks.push(now);
                        // Increased window to 15s to detect patterns over longer duration
                        APP.runtime.recentSlowBlinks = APP.runtime.recentSlowBlinks.filter(t => now - t < 15000);
                        if (APP.runtime.recentSlowBlinks.length >= 3 && !APP.runtime.isAlarming && APP.runtime.warningType !== 'FATIGUE') {
                            showWarning('FATIGUE');
                        }
                    }
                    updateFatigueDots();
                }
                APP.runtime.closedCounter = 0;
                UI.barCursor.style.background = '#fff';
                
                // DISTRACTION COUNTER LOGIC (Only reset if looking straight)
                if (isDistracted) APP.runtime.distractionCounter++; 
                else APP.runtime.distractionCounter = 0; // Look straight = reset

                if (APP.runtime.isAlarming && percent * 100 > 60) { stopAlarm(); UI.alarmScreen.classList.remove('alarm-active'); }
                if (APP.runtime.warningType === 'DISTRACTION' && !isDistracted) hideWarning();
                if (APP.runtime.warningType === 'FATIGUE' && percent * 100 > 70) hideWarning();
            }

            if (APP.runtime.closedCounter > APP.config.framesToAlarm) {
                if (!APP.runtime.isAlarming) {
                    APP.runtime.isAlarming = true; UI.alarmScreen.classList.add('alarm-active'); playTone('ALARM'); hideWarning();
                }
            } else if (APP.runtime.distractionCounter > APP.config.distractionFrames) {
                if (!APP.runtime.isAlarming && APP.runtime.warningType !== 'DISTRACTION') { showWarning('DISTRACTION'); }
            }

            if (APP.runtime.closedCounter > 0) UI.monitorStatus.innerHTML = "<span class='text-red-500'>‚ö†Ô∏è ƒêANG NH·∫ÆM</span>";
            else if (APP.runtime.warningType === 'DISTRACTION') UI.monitorStatus.innerHTML = "<span class='text-orange-500'>üëÄ NH√åN ƒê∆Ø·ªúNG!</span>";
            else if (APP.runtime.warningType === 'FATIGUE') UI.monitorStatus.innerHTML = "<span class='text-yellow-400'>‚òï M·ªÜT M·ªéI</span>";
            else UI.monitorStatus.innerHTML = "<span class='text-green-400'>‚úÖ T·ªânh t√°o</span>";
        }

        function updateFatigueDots() {
            const count = APP.runtime.recentSlowBlinks.length;
            UI.dots.forEach((d, i) => { if (i < count) d.classList.add('active'); else d.classList.remove('active'); });
        }
        function showWarning(type) {
            APP.runtime.warningType = type; UI.warningOverlay.classList.add('warning-active');
            if (type === 'DISTRACTION') {
                UI.warningOverlay.className = "warning-overlay warn-orange warning-active";
                UI.warnIcon.innerText = "üëÄ"; UI.warnTitle.innerText = "NH√åN ƒê∆Ø·ªúNG"; UI.warnSub.innerText = "T·∫≠p trung l√°i xe"; playTone('DISTRACTION'); speak("H√£y nh√¨n ƒë∆∞·ªùng.");
            } else if (type === 'FATIGUE') {
                UI.warningOverlay.className = "warning-overlay warn-yellow warning-active";
                UI.warnIcon.innerText = "‚òï"; UI.warnTitle.innerText = "M·ªÜT M·ªéI"; UI.warnSub.innerText = "B·∫°n ch·ªõp m·∫Øt ch·∫≠m"; playTone('FATIGUE'); speak("B·∫°n ƒëang m·ªát.");
            }
        }
        function hideWarning() { UI.warningOverlay.classList.remove('warning-active'); APP.runtime.warningType = null; }

        function onResults(results) {
            UI.canvas.width = UI.video.videoWidth; UI.canvas.height = UI.video.videoHeight;
            UI.ctx.save(); UI.ctx.clearRect(0, 0, UI.canvas.width, UI.canvas.height); UI.ctx.drawImage(results.image, 0, 0, UI.canvas.width, UI.canvas.height);
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const lm = results.multiFaceLandmarks[0];
                const ear = getEAR(lm); const pose = getHeadPose(lm); 
                let meshColor = '#FFFFFF10'; if (APP.mode.startsWith('TRAIN')) meshColor = '#3b82f680';
                drawConnectors(UI.ctx, lm, FACEMESH_TESSELATION, {color: meshColor, lineWidth: 0.5});
                
                if (APP.mode.startsWith('TRAIN')) { 
                    APP.tempTrainData.push(ear);
                    if (APP.mode === 'TRAIN_OPEN' && !UI.calibMsg.classList.contains('hidden')) {
                        APP.calibData.pitch += pose.pitch; APP.calibData.yaw += pose.yaw; APP.calibData.count++;
                    }
                } else if (APP.mode === 'MONITOR') { 
                    processMonitor(ear, pose.pitch, pose.yaw); 
                    const col = APP.runtime.currentEAR < APP.config.eyeThreshold ? '#ef4444' : '#22c55e';
                    drawConnectors(UI.ctx, lm, [[33,133], [362,263]], {color: col, lineWidth: 3});
                }
            }
            UI.ctx.restore();
        }

        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        faceMesh.onResults(onResults);
        const camera = new Camera(UI.video, {onFrame: async () => await faceMesh.send({image: UI.video}), width: 1280, height: 720});

        function toggleMute() { APP.runtime.isMuted = !APP.runtime.isMuted; const i = APP.runtime.isMuted ? 'üîá' : 'üîä'; const t = APP.runtime.isMuted ? '√Çm thanh: T·∫ÆT' : '√Çm thanh: B·∫¨T'; UI.btnQuickMute.innerText = i; document.getElementById('menuMute').innerHTML = `<span>${i}</span> <span>${t}</span>`; }
        UI.btnQuickMute.onclick = toggleMute; document.getElementById('menuMute').onclick = toggleMute;
        document.getElementById('btnOpenSettings').onclick = () => UI.settingsMenu.classList.toggle('open');
        document.addEventListener('click', (e) => { if (!UI.settingsMenu.contains(e.target) && !document.getElementById('btnOpenSettings').contains(e.target)) UI.settingsMenu.classList.remove('open'); });
        function updateDelayVal(val) { UI.delayVal.innerText = `${(val / 30).toFixed(1)}s`; }
        UI.delaySlider.oninput = (e) => { const val = parseInt(e.target.value); APP.config.framesToAlarm = val; updateDelayVal(val); saveConfig(); };
        document.getElementById('menuRetrain').onclick = () => { UI.settingsMenu.classList.remove('open'); UI.monitorBar.classList.add('opacity-0', 'pointer-events-none'); UI.bottomControls.classList.add('hidden'); UI.trainingContainer.classList.remove('hidden'); showStep('stepWelcome'); APP.mode = 'IDLE'; stopAlarm(); };
        document.getElementById('menuReset').onclick = clearConfig;
        document.getElementById('btnNewTrain').onclick = () => { initAudio(); camera.start(); showStep('stepInstructOpen'); };
        document.getElementById('btnUseOld').onclick = () => { initAudio(); camera.start(); startMonitor(); };
        document.getElementById('btnStartOpen').onclick = () => startCountdown(() => runCapture('TRAIN_OPEN'));
        document.getElementById('btnStartClosed').onclick = () => startCountdown(() => runCapture('TRAIN_CLOSED'));
        document.getElementById('btnFinish').onclick = startMonitor;
        document.getElementById('btnWakeUp').onclick = () => { stopAlarm(); UI.alarmScreen.classList.remove('alarm-active'); APP.runtime.closedCounter = 0; };

        checkStorage();
    </script>
</body>
</html>


